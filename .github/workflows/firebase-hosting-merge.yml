# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
'on':
  push:
    branches:
      - main
env:
  NEXT_PUBLIC_ANALYTICS_ID: 'UA-130018-1'
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - id: get_version
        uses: battila7/get-version-action@v2

      - run: echo ${{ steps.get_version.outputs.version }}

      - run: echo ${{ steps.get_version.outputs.version-without-v }}

      # - name: Set Release version
      #   run: echo "NEXT_PUBLIC_RELEASE_VERSION=${GITHUB_REF} >> $GITHUB_ENV
      #   # run: echo "NEXT_PUBLIC_RELEASE_VERSION=$(echo ${GITHUB_REF} | sed -e "s/refs\/tags\///g" | sed -e "s/\//-/g")"  >> $GITHUB_ENV

      - name: Checkout source
        uses: actions/checkout@v2

      - name: Build
        # env:
        #   NEXT_PUBLIC_RELEASE_VERSION: ${{ env.NEXT_PUBLIC_RELEASE_VERSION }}
        run: npm ci && npm run build

      - name: Deploy to Firebase
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_EFFECTIVE_ADVENTURE }}'
          channelId: live
          projectId: effective-adventure

      - name: Deploy to IPFS
        uses: aquiladev/ipfs-action@v0.2.1
        with:
          path: ./dist/apps/webapp/exported
          service: pinata
          pinataKey: ${{ secrets.PINATA_KEY }}
          pinataSecret: ${{ secrets.PINATA_SECRET }}
          pinataPinName: effective-adventure-webapp-${{ steps.get_version.outputs.version }}

      # "bafkreicysg23kiwv34eg2d7qweipxwosdo2py4ldv42nbauguluen5v6am"
      - run: echo /ipfs/${{ steps.ipfs.outputs.cid }}

      # https://bafkreicysg23kiwv34eg2d7qweipxwosdo2py4ldv42nbauguluen5v6am.ipfs.dweb.link
      - run: echo ${{ steps.ipfs.outputs.url }}
